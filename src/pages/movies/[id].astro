---
import { getCollection, getEntry, render } from "astro:content";
import { getMovie } from "../../../lib/tmdb";
import MovieReviewPostLayout from "@layouts/MovieReviewPostLayout.astro";

// get local movie post from movies content collections
export async function getStaticPaths() {
  const localMovies = await getCollection("movies", ({ data }) => {
    return import.meta.env.PROD ? data.published === true : true;
  });
  // set the movie id as params
  return localMovies.map((localMovie) => ({
    params: {
      id: localMovie.id,
    },
  }));
}

// catch the params
const params = Astro.params;

// get current movie post using their id as params
const localMovie = await getEntry("movies", params.id);
if (!localMovie) throw new Error(`Movie not found: ${params.id}`);

const { Content, remarkPluginFrontmatter } = await render(localMovie);
// get curent movie remote data using their imdb id
const remoteMovieData = await getMovie(localMovie.data.imdbId);
if (!remoteMovieData) return null;

// merged remote movie data from tmdb api and local movie data from content collections
const mergedMovieData = {
  ...remoteMovieData,
  ...remarkPluginFrontmatter,
};
---

<MovieReviewPostLayout movie={mergedMovieData}>
  <Content />
</MovieReviewPostLayout>
